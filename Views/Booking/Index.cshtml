@model VillaManagementWeb.ViewModels.RoomBookingDetailVM
@{
    ViewData["Title"] = "Chi tiết & Đặt phòng";
    Layout = "~/Views/Shared/_Layout_Tailwind.cshtml";
}

<div class="bg-gray-50 min-h-screen py-10">
    <div class="container mx-auto px-4 max-w-6xl">

        <div class="text-sm text-gray-500 mb-6">
            <a href="/" class="hover:text-[#A67C52]">Trang chủ</a>
            <span class="mx-2">/</span>
            <span class="text-[#A67C52]">Đặt phòng: @Model.CategoryName - @Model.RoomName</span>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">

            <div class="w-full lg:w-2/3 space-y-8">

                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="aspect-video relative">
                        <img src="@Model.ImageUrl" class="w-full h-full object-cover" id="mainImage">
                    </div>
                    <div class="grid grid-cols-4 gap-2 p-2">
                        @foreach (var img in Model.GalleryImages.Take(4))
                        {
                            <div class="aspect-video cursor-pointer opacity-70 hover:opacity-100 transition" onclick="document.getElementById('mainImage').src='@img'">
                                <img src="@img" class="w-full h-full object-cover rounded">
                            </div>
                        }
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-serif text-[#A67C52] mb-4">@Model.CategoryName - @Model.RoomName</h2>
                    <div class="prose max-w-none text-gray-600 mb-6">
                        @Html.Raw(Model.Description)
                    </div>

                    <h3 class="font-bold text-gray-800 mb-3">Tiện nghi phòng</h3>
                    <div class="grid grid-cols-2 gap-3">
                        @foreach (var item in Model.Amenities)
                        {
                            var parts = item.Split('|');
                            <div class="flex items-center gap-2 text-sm text-gray-600">
                                <i class="fas fa-check text-[#A67C52]"></i> @parts[0]
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="w-full lg:w-1/3">
                <div class="bg-white p-6 rounded-lg shadow-lg sticky top-6 border-t-4 border-[#A67C52]">
                    <h3 class="text-xl font-bold uppercase text-center mb-6 text-gray-800">Thông tin đặt phòng</h3>

                    <form asp-action="Create" method="post" id="bookingForm">
                        @if (!ViewData.ModelState.IsValid)
                        {
                            <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-exclamation-circle text-red-500"></i>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-red-800">Có lỗi xảy ra:</h3>
                                        <div class="mt-2 text-sm text-red-700">
                                            <div asp-validation-summary="All" class="list-disc pl-5 space-y-1"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        <input type="hidden" asp-for="BookingRequest.RoomId" />
                        <input type="hidden" id="basePrice" value="@Model.PricePerNight" />

                        <div class="grid grid-cols-1 gap-4 mb-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">NHẬN PHÒNG (Ngày & Giờ)</label>
                                <input asp-for="BookingRequest.CheckIn"
                                       type="text"
                                       readonly class="w-full border-gray-300 rounded focus:ring-[#A67C52] focus:border-[#A67C52] date-picker bg-white cursor-pointer"
                                       id="checkInDate"
                                       placeholder="Bấm để chọn ngày..."
                                       value="@Model.BookingRequest.CheckIn.ToString("yyyy-MM-dd HH:mm")" />
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">TRẢ PHÒNG (Ngày & Giờ)</label>
                                <input asp-for="BookingRequest.CheckOut"
                                       type="text"
                                       readonly class="w-full border-gray-300 rounded focus:ring-[#A67C52] focus:border-[#A67C52] date-picker bg-white cursor-pointer"
                                       id="checkOutDate"
                                       placeholder="Bấm để chọn ngày..."
                                       value="@Model.BookingRequest.CheckOut.ToString("yyyy-MM-dd HH:mm")" />
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-xs font-bold text-gray-500 mb-1">SỐ LƯỢNG PHÒNG Còn trống</label>
                            <select class="w-full border-gray-300 rounded focus:ring-[#A67C52]" id="roomQty" onchange="calculateTotal()">
                                @for (int i = 1; i <= Model.MaxAvailableSlots; i++)
                                {
                                    <option value="@i">@i Phòng</option>
                                }
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Người lớn</label>
                            <input asp-for="BookingRequest.AdultsCount"
                                   type="number"
                                   id="AdultsCount"
                                   min="1"
                                   max="@Model.CapacityAdults"
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-[#A67C52] focus:ring focus:ring-[#A67C52] focus:ring-opacity-50" />

                            <span id="adult-error" class="text-red-500 text-sm hidden">Vượt quá số lượng người lớn cho phép!</span>
                            <span asp-validation-for="BookingRequest.AdultsCount" class="text-red-500 text-sm"></span>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Trẻ em</label>
                            <input asp-for="BookingRequest.ChildrenCount"
                                   type="number"
                                   id="ChildrenCount"
                                   min="0"
                                   max="@Model.CapacityChildren"
                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-[#A67C52] focus:ring focus:ring-[#A67C52] focus:ring-opacity-50" />

                            <span id="child-error" class="text-red-500 text-sm hidden">Vượt quá số lượng trẻ em cho phép!</span>
                            <span asp-validation-for="BookingRequest.ChildrenCount" class="text-red-500 text-sm"></span>
                        </div>

                        <div class="space-y-3 mb-6 border-t pt-4">
                            <h4 class="font-bold text-sm">Thông tin liên hệ</h4>
                            <input asp-for="BookingRequest.CustomerName" placeholder="Họ và tên *" class="w-full border-gray-300 rounded text-sm" required>
                            <input asp-for="BookingRequest.CustomerPhone" placeholder="Số điện thoại *" class="w-full border-gray-300 rounded text-sm" required>
                            <input asp-for="BookingRequest.IdentityCard" placeholder="CCCD *" class="w-full border-gray-300 rounded text-sm" required>
                            <input asp-for="BookingRequest.Nationality" placeholder="Quốc tịch *" class="w-full border-gray-300 rounded text-sm" required>
                            <input asp-for="BookingRequest.CustomerEmail" type="email" placeholder="Email (để nhận vé)" class="w-full border-gray-300 rounded text-sm">
                            <textarea asp-for="BookingRequest.Notes" placeholder="Ghi chú thêm..." class="w-full border-gray-300 rounded text-sm h-20"></textarea>
                        </div>
                        <div class="mt-4 mb-6">
                            <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">Phương thức thanh toán</label>

                            <div class="space-y-3">
                                <div class="flex items-center border border-gray-200 p-3 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                                    <input asp-for="BookingRequest.PaymentMethod" type="radio" value="BankTransfer" id="pm_bank"
                                           class="h-4 w-4 text-[#A67C52] focus:ring-[#A67C52] border-gray-300" checked>
                                    <label for="pm_bank" class="ml-3 block text-sm font-medium text-gray-700 cursor-pointer flex-1">
                                        <i class="fas fa-qrcode text-[#A67C52] mr-2"></i> Chuyển khoản ngân hàng (QR Code)
                                    </label>
                                </div>

                                <div class="flex items-center border border-gray-200 p-3 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                                    <input asp-for="BookingRequest.PaymentMethod" type="radio" value="Cash" id="pm_cash"
                                           class="h-4 w-4 text-[#A67C52] focus:ring-[#A67C52] border-gray-300">
                                    <label for="pm_cash" class="ml-3 block text-sm font-medium text-gray-700 cursor-pointer flex-1">
                                        <i class="fas fa-money-bill-wave text-green-600 mr-2"></i> Tiền mặt khi nhận phòng
                                    </label>
                                </div>
                            </div>
                            <span asp-validation-for="BookingRequest.PaymentMethod" class="text-red-500 text-xs mt-1 block"></span>
                        </div>

                        <div class="bg-gray-50 p-4 rounded mb-6">
                            <div class="flex justify-between mb-2 text-sm">
                                <span>Giá phòng:</span>
                                <span>@Model.PricePerNight.ToString("N0") đ / đêm</span>
                            </div>
                            <div class="flex justify-between mb-2 text-sm">
                                <span>Số đêm:</span>
                                <span id="displayNights">1</span>
                            </div>
                            <div class="flex justify-between font-bold text-lg text-[#A67C52] border-t pt-2 mt-2">
                                <span>TỔNG CỘNG:</span>
                                <span id="displayTotal">@Model.PricePerNight.ToString("N0") đ</span>
                                <input type="hidden" asp-for="BookingRequest.TotalAmount" id="hiddenTotal" />
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-[#A67C52] text-white py-3 font-bold uppercase tracking-widest hover:opacity-90 rounded transition">
                            Xác nhận đặt phòng
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- 1. KHAI BÁO BIẾN DÙNG CHUNG ---
            const checkInInput = document.getElementById('checkInDate');
            const checkOutInput = document.getElementById('checkOutDate');
            const qtySelect = document.getElementById('roomQty'); // Input số lượng phòng (nếu có)
            const roomIdInput = document.getElementById('BookingRequest_RoomId'); // Hidden input

            // Lấy giới hạn người từ Model (Server-side render ra số)
            const maxAdults = @Model.CapacityAdults;
            const maxChildren = @Model.CapacityChildren;

            // --- 2. HÀM TÍNH TIỀN ---
            function calculateTotal() {
                // Đảm bảo input giá và input CheckIn/Out tồn tại
                const basePriceElement = document.getElementById('basePrice');
                if (!basePriceElement || !checkInInput || !checkOutInput) return;

                const price = parseFloat(basePriceElement.value) || 0;
                const qty = qtySelect ? parseInt(qtySelect.value) : 1;

                const checkInVal = checkInInput.value;
                const checkOutVal = checkOutInput.value;

                if (!checkInVal || !checkOutVal) return;

                const checkIn = new Date(checkInVal);
                const checkOut = new Date(checkOutVal);

                if (checkOut <= checkIn) return; // Ngày không hợp lệ thì không tính

                // Tính số mili-giây chênh lệch
                let timeDiff = checkOut.getTime() - checkIn.getTime();

                // Đổi ra số ngày (đêm)
                let nights = timeDiff / (1000 * 3600 * 24);
                nights = Math.ceil(nights);
                if (nights < 1) nights = 1;

                const total = price * nights * qty;

                // Cập nhật giao diện
                const displayNights = document.getElementById('displayNights');
                const displayTotal = document.getElementById('displayTotal');
                const hiddenTotal = document.getElementById('hiddenTotal'); // Input hidden lưu tổng tiền

                if (displayNights) displayNights.innerText = nights;
                if (displayTotal) displayTotal.innerText = total.toLocaleString('vi-VN') + ' đ';
                if (hiddenTotal) hiddenTotal.value = total;
            }

            // --- 3. HÀM CHECK PHÒNG TRỐNG (AJAX) ---
            async function updateAvailableSlots() {
                const checkInVal = checkInInput.value;
                const checkOutVal = checkOutInput.value;
                const roomId = roomIdInput ? roomIdInput.value : 0;

                if (!checkInVal || !checkOutVal || !qtySelect) return;

                try {
                    // Gọi API (Backend cần có Action CheckAvailability)
                    const response = await fetch(`/Booking/CheckAvailability?roomId=${roomId}&checkIn=${checkInVal}&checkOut=${checkOutVal}`);
                    if (!response.ok) return;

                    const data = await response.json();
                    const maxSlots = data.maxSlots;

                    // Xóa option cũ
                    qtySelect.innerHTML = '';

                    if (maxSlots > 0) {
                        for (let i = 1; i <= maxSlots; i++) {
                            let option = document.createElement("option");
                            option.value = i;
                            option.text = i + " Phòng";
                            qtySelect.add(option);
                        }
                    } else {
                        let option = document.createElement("option");
                        option.text = "Hết phòng";
                        qtySelect.add(option);
                        alert("Rất tiếc, ngày bạn chọn đã hết phòng loại này!");
                    }

                    // Tính lại tiền sau khi update số lượng
                    calculateTotal();

                } catch (error) {
                    console.error('Lỗi check phòng:', error);
                }
            }

            // --- 4. CẤU HÌNH FLATPICKR (LỊCH) ---
            const checkInPicker = flatpickr("#CheckIn", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                altInput: true,
                altFormat: "d/m/Y h:i K",
                minDate: "today",
                defaultHour: 14,
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length > 0) {
                        const startDate = selectedDates[0];

                        // Tự động set minDate cho CheckOut là ngày hôm sau (hoặc sau ít nhất 1 khoảng)
                        const minCheckOutDate = new Date(startDate);
                        // minCheckOutDate.setDate(minCheckOutDate.getDate() + 1);

                        checkOutPicker.set('minDate', minCheckOutDate);

                        // Nếu ngày CheckOut hiện tại < ngày CheckIn mới -> Reset CheckOut
                        const currentEndDate = checkOutPicker.selectedDates[0];
                        if (currentEndDate && currentEndDate <= startDate) {
                            const nextDay = new Date(startDate);
                            nextDay.setDate(nextDay.getDate() + 1);
                            nextDay.setHours(12, 0, 0, 0);
                            checkOutPicker.setDate(nextDay);
                        }
                    }
                    updateAvailableSlots();
                }
            });

            const checkOutPicker = flatpickr("#CheckOut", {
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                altInput: true,
                altFormat: "d/m/Y h:i K",
                minDate: "today",
                defaultHour: 12,
                onChange: function(selectedDates, dateStr, instance) {
                    const endDate = selectedDates[0];
                    const startDate = checkInPicker.selectedDates[0];

                    if (startDate && endDate <= startDate) {
                        alert("Ngày trả phòng phải sau ngày nhận phòng!");
                        // Reset về ngày hợp lệ
                        const validDate = new Date(startDate);
                        validDate.setDate(validDate.getDate() + 1);
                        checkOutPicker.setDate(validDate);
                    }
                    updateAvailableSlots();
                }
            });

            // --- 5. VALIDATION SỐ LƯỢNG NGƯỜI (REAL-TIME) ---
            const adultInput = document.getElementById("AdultsCount");
            const childInput = document.getElementById("ChildrenCount");

            function validateGuestInput(input, max, errorId) {
                if (!input) return;
                input.addEventListener("input", function() {
                    const val = parseInt(this.value) || 0;
                    const errorMsg = document.getElementById(errorId);

                    if (val > max) {
                        if (errorMsg) {
                            errorMsg.classList.remove("hidden");
                            errorMsg.innerText = `Tối đa ${max} người.`;
                        }
                        this.value = max; // Reset về max
                    } else {
                        if (errorMsg) errorMsg.classList.add("hidden");
                    }
                });
            }

            validateGuestInput(adultInput, maxAdults, "adult-error");
            validateGuestInput(childInput, maxChildren, "child-error");

            // --- 6. CHẠY KHỞI TẠO ---
            calculateTotal(); // Tính tiền lần đầu khi load trang
        });
    </script>
}