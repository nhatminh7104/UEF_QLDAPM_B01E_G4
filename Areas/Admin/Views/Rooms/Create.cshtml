@model VillaManagementWeb.Models.Room

@{
    ViewData["Title"] = "Thêm phòng mới";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="page-inner">
    <form asp-action="Create" method="post" enctype="multipart/form-data">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <input type="hidden" name="coverIndex" id="coverIndex" value="0" />

        <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
            <div>
                <h3 class="fw-bold mb-3">Thêm Phòng Mới</h3>
                <h6 class="op-7 mb-2">Thiết lập thông tin chi tiết và hình ảnh cho phòng nghỉ.</h6>
            </div>
            <div class="ms-md-auto py-2 py-md-0">
                <button type="submit" class="btn btn-primary btn-round me-2">Lưu phòng</button>
                <a asp-action="Index" class="btn btn-border btn-round">Hủy bỏ</a>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card border-0 shadow-sm mb-4" style="border-radius: 12px;">
                    <div class="card-header bg-light border-bottom py-3">
                        <h5 class="card-title mb-0 fw-bold text-dark d-flex align-items-center gap-2">
                            <i class="fas fa-info-circle text-primary"></i> Thông tin cơ bản
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Số phòng (Room No.) <span
                                        class="text-danger">*</span></label>
                                <input asp-for="RoomNumber" class="form-control" placeholder="VD: A-101" />
                                <span asp-validation-for="RoomNumber" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Loại phòng <span class="text-danger">*</span></label>
                                <select asp-for="Type" class="form-select">
                                    <option value="Villa">Villa</option>
                                    <option value="Bungalow">Bungalow</option>
                                    <option value="Suite">Suite</option>
                                    <option value="Red Rose House">Red Rose House</option>
                                    <option value="Forest Room">Forest Room</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Giá mỗi đêm <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input asp-for="PricePerNight" class="form-control" placeholder="0" />
                                    <span class="input-group-text">VND</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Diện tích</label>
                                <div class="input-group">
                                    <input asp-for="SquareFootage" class="form-control" placeholder="0" />
                                    <span class="input-group-text">m²</span>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-bold">Sức chứa (Người)</label>
                                <input asp-for="Capacity" class="form-control" type="number" min="1" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Số giường</label>
                                <input asp-for="Beds" class="form-control" type="number" min="1" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Hạng (Sao)</label>
                                <select asp-for="RatingStars" class="form-select">
                                    <option value="1">1 Sao</option>
                                    <option value="2">2 Sao</option>
                                    <option value="3">3 Sao</option>
                                    <option value="4">4 Sao</option>
                                    <option value="5">5 Sao</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-4" style="border-radius: 12px;">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-4 d-flex align-items-center gap-2">
                            <i class="fas fa-file-alt text-primary"></i> Mô tả chi tiết
                        </h5>
                        <textarea id="Description" asp-for="Description" class="form-control"></textarea>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card border-0 shadow-sm mb-4" style="border-radius: 12px;">
                    <div class="card-header bg-light">
                        <h5 class="card-title mb-0 fw-bold">Tiện ích & Trạng thái</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="form-check form-switch mb-4">
                            <input class="form-check-input" type="checkbox" asp-for="IsActive" checked>
                            <label class="form-check-label fw-bold ms-2">Đang hoạt động</label>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" asp-for="HasWifi">
                                    <label class="form-check-label">Wifi</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" asp-for="HasPool">
                                    <label class="form-check-label">Hồ bơi</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" asp-for="HasBreakfast">
                                    <label class="form-check-label">Bữa sáng</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" asp-for="HasTowel">
                                    <label class="form-check-label">Khăn tắm</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-4" style="border-radius: 12px;">
                    <div class="card-header bg-light">
                        <h5 class="card-title mb-0 fw-bold">Thư viện ảnh</h5>
                    </div>
                    <div class="card-body p-4 text-center">
                        <div class="upload-area border-2 border-dashed rounded-3 p-4 bg-light cursor-pointer mb-3"
                            onclick="document.getElementById('imageInput').click()">
                            <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
                            <p class="small mb-0">Nhấn để tải ảnh</p>
                            <input type="file" id="imageInput" name="imageFiles" class="d-none" accept="image/*"
                                onchange="previewImages(this)" multiple />
                        </div>
                        <div id="imagePreviewContainer" class="row g-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Biến toàn cục để lưu trữ danh sách file thực tế sẽ gửi lên server
        // 1. Hàm vẽ lại toàn bộ preview dựa trên những gì đang có trong thẻ input
        // Khởi tạo bộ nhớ tạm để giữ tất cả file qua nhiều lần chọn
        let allFilesDT = new DataTransfer();

        function previewImages(input) {
            const container = document.getElementById('imagePreviewContainer');

            // 1. Lấy các file MỚI chọn và thêm vào bộ nhớ tạm allFilesDT
            if (input.files && input.files.length > 0) {
                for (let i = 0; i < input.files.length; i++) {
                    allFilesDT.items.add(input.files[i]);
                }
            }

            // 2. Cập nhật ngược lại thẻ input để khi submit Form sẽ gửi ĐẦY ĐỦ file
            input.files = allFilesDT.files;

            // 3. Vẽ lại giao diện từ bộ nhớ tạm
            renderPreview();
        }

        // Thay thế đoạn script cũ trong Create.cshtml bằng đoạn này
        function renderPreview() {
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = '';
            const files = allFilesDT.files;
            const currentCoverIndex = parseInt(document.getElementById('coverIndex').value);

            for (let i = 0; i < files.length; i++) {
                const reader = new FileReader();
                const fileIndex = i;

                reader.onload = function (e) {
                    const isCover = fileIndex === currentCoverIndex;
                    const html = `
                                                    <div class="col-md-3 col-6 mb-3 image-item">
                                                        <div class="position-relative rounded overflow-hidden shadow-sm border ${isCover ? 'border-primary border-3' : ''}" style="aspect-ratio: 4/3;">
                                                            <img src="${e.target.result}" class="w-100 h-100 object-fit-cover" />

                                                            <span class="position-absolute top-0 start-0 m-2 badge ${isCover ? 'bg-primary' : 'bg-secondary cursor-pointer'}"
                                                                  onclick="setAsCover(${fileIndex})">
                                                                ${isCover ? 'COVER' : 'LÀM ĐẠI DIỆN'}
                                                            </span>

                                                            <div class="position-absolute top-0 end-0 m-2">
                                                                <button type="button" class="btn btn-sm btn-danger p-1 rounded-circle shadow"
                                                                        onclick="removeImage(${fileIndex})">
                                                                    <i class="fas fa-times"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>`;
                    container.insertAdjacentHTML('beforeend', html);
                };
                reader.readAsDataURL(files[i]);
            }
        }

        // Hàm mới để thay đổi ảnh đại diện
        function setAsCover(index) {
            document.getElementById('coverIndex').value = index;
            renderPreview();
        }

        // Cập nhật lại hàm xóa để reset coverIndex nếu cần
        function removeImage(fileIndex) {
            const input = document.getElementById('imageInput');
            const newDT = new DataTransfer();
            const files = allFilesDT.files;
            let currentCover = parseInt(document.getElementById('coverIndex').value);

            for (let i = 0; i < files.length; i++) {
                if (i !== fileIndex) {
                    newDT.items.add(files[i]);
                }
            }

            // Điều chỉnh lại coverIndex sau khi xóa
            if (fileIndex === currentCover) {
                document.getElementById('coverIndex').value = 0; // Reset về ảnh đầu tiên
            } else if (fileIndex < currentCover) {
                document.getElementById('coverIndex').value = currentCover - 1;
            }

            allFilesDT = newDT;
            input.files = allFilesDT.files;
            renderPreview();
        }

        // 2. Xử lý chọn Rating Star bằng click chuột
        $(document).ready(function () {
            $('.star-item').on('click', function () {
                const val = $(this).data('value');
                $('#ratingValue').val(val);
                $('#ratingText').text(`(${val}.0)`);

                $('.star-item').each(function (index) {
                    if (index < val) {
                        $(this).removeClass('far').addClass('fas');
                    } else {
                        $(this).removeClass('fas').addClass('far');
                    }
                });
            });
        });
    </script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}